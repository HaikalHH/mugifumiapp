generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

// Application users and roles
model User {
  id                 Int      @id @default(autoincrement())
  username           String   @unique
  name               String
  role               String // Admin | Manager | Sales | Bandung | Jakarta
  passwordHash       String
  baseSalary         Int      @default(0)
  workStartMinutes   Int      @default(540) // 09:00 local
  workEndMinutes     Int      @default(1020) // 17:00 local
  overtimeHourlyRate Int?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  attendances      Attendance[]
  overtimeRequests OvertimeRequest[]
  bonuses          UserBonus[]
  manualPenalties  ManualPenalty[]
  payrollSnapshots PayrollSnapshot[]
}

model Attendance {
  id         Int       @id @default(autoincrement())
  userId     Int
  date       DateTime // Jakarta local date anchored at 00:00 UTC
  clockInAt  DateTime
  clockOutAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@index([userId, date])
}

model OvertimeRequest {
  id           Int       @id @default(autoincrement())
  userId       Int
  startAt      DateTime
  endAt        DateTime
  status       String    @default("PENDING") // PENDING | APPROVED | REJECTED
  approvedById Int?
  approvedAt   DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@index([userId, startAt])
}

model Product {
  id                Int            @id @default(autoincrement())
  code              String         @unique
  name              String
  price             Int
  description       String?        @db.Text
  longDescription   String?        @db.Text
  ingredients       String?        @db.Text
  allergens         String?        @db.Text
  badge             String?
  category          String?
  showInMarketplace Boolean        @default(true)
  hppPct            Float
  hppValue          Int
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  attachments       Media[]
  inventory         Inventory[]
  sales             SaleItem[]
  orderItems        OrderItem[]
  deliveryItems     DeliveryItem[]
  b2bOrderItems     OrderB2BItem[] @relation("OrderB2BItemRetailProduct")
}

// Separate master data for planning helper
model PlanProduct {
  id        Int      @id @default(autoincrement())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  recipeItems RecipeItem[]
}

model Inventory {
  id        Int      @id @default(autoincrement())
  barcode   String   @unique
  location  String
  productId Int
  createdAt DateTime @default(now())
  status    String   @default("READY")
  product   Product  @relation(fields: [productId], references: [id])
}

model Media {
  id           Int      @id @default(autoincrement())
  url          String
  altText      String?
  type         String?
  width        Int?
  height       Int?
  displayOrder Int      @default(0)
  productId    Int?
  product      Product? @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
}

model Sale {
  id             Int        @id @default(autoincrement())
  outlet         String
  customer       String?
  status         String     @default("ordered")
  orderDate      DateTime
  shipDate       DateTime?
  estPayout      Int?
  actPayout      Int?
  location       String
  discount       Float?
  actualReceived Int?
  createdAt      DateTime   @default(now())
  items          SaleItem[]
}

model SaleItem {
  id        Int     @id @default(autoincrement())
  saleId    Int
  productId Int
  barcode   String
  price     Int
  status    String?
  product   Product @relation(fields: [productId], references: [id])
  sale      Sale    @relation(fields: [saleId], references: [id])
}

model Order {
  id                    Int         @id @default(autoincrement())
  outlet                String
  customer              String?
  status                String      @default("PAID")
  orderDate             DateTime
  deliveryDate          DateTime?
  location              String
  discount              Float?
  totalAmount           Int?
  actPayout             Int?
  ongkirPlan            Int?
  selfPickup            Boolean     @default(false)
  createdAt             DateTime    @default(now())
  paymentLink           String?
  midtransOrderId       String?
  midtransTransactionId String?
  midtransFee           Int?
  items                 OrderItem[]
  deliveries            Delivery[]
}

model OrderItem {
  id        Int     @id @default(autoincrement())
  orderId   Int
  productId Int
  quantity  Int
  price     Int
  product   Product @relation(fields: [productId], references: [id])
  order     Order   @relation(fields: [orderId], references: [id])
}

model Delivery {
  id           Int            @id @default(autoincrement())
  orderId      Int
  deliveryDate DateTime?
  status       String         @default("pending") // pending, delivered
  ongkirPlan   Int? // Ongkir (Plan) in Rupiah
  ongkirActual Int? // Ongkir (Actual) in Rupiah
  createdAt    DateTime       @default(now())
  items        DeliveryItem[]
  order        Order          @relation(fields: [orderId], references: [id])
}

model DeliveryItem {
  id         Int      @id @default(autoincrement())
  deliveryId Int
  productId  Int
  barcode    String
  price      Int
  product    Product  @relation(fields: [productId], references: [id])
  delivery   Delivery @relation(fields: [deliveryId], references: [id])
}

// B2B master product table (separate from retail)
model ProductB2B {
  id        Int            @id @default(autoincrement())
  code      String         @unique
  name      String
  price     Int
  hppPct    Float?         @map("hpp_pct")
  hppValue  Int?           @map("hpp_value")
  createdAt DateTime       @default(now()) @map("created_at")
  updatedAt DateTime       @updatedAt @map("updated_at")
  items     OrderB2BItem[]

  @@map("product_b2b")
}

// B2B order header (for Wholesale/Cafe)
model OrderB2B {
  id          Int            @id @default(autoincrement())
  outlet      String
  customer    String?
  status      String         @default("PAID")
  orderDate   DateTime       @map("order_date")
  location    String
  discount    Float?
  totalAmount Int?           @map("total_amount")
  actPayout   Int?           @map("act_payout")
  createdAt   DateTime       @default(now()) @map("created_at")
  items       OrderB2BItem[]

  @@map("order_b2b")
}

// B2B order items
model OrderB2BItem {
  id              Int         @id @default(autoincrement())
  orderId         Int         @map("order_id")
  productId       Int?        @map("product_id")
  retailProductId Int?        @map("retail_product_id")
  productSource   String      @default("B2B") @map("product_source")
  barcode         String?
  quantity        Int
  price           Int
  product         ProductB2B? @relation(fields: [productId], references: [id])
  retailProduct   Product?    @relation("OrderB2BItemRetailProduct", fields: [retailProductId], references: [id])
  order           OrderB2B    @relation(fields: [orderId], references: [id])

  @@map("order_b2b_item")
}

model ManualPenalty {
  id        Int      @id @default(autoincrement())
  userId    Int
  year      Int
  month     Int
  amount    Int
  reason    String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId, year, month])
}

// Ingredient master data (bahan)
model Ingredient {
  id        Int      @id @default(autoincrement())
  code      String   @unique
  name      String
  unit      String // gram | liter
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  recipeItems RecipeItem[]
}

// Recipe item per product per 1 kg output
model RecipeItem {
  id           Int      @id @default(autoincrement())
  productId    Int
  ingredientId Int
  amountPerKg  Float // amount needed per 1 kg of product
  unit         String // duplicate for clarity, e.g. gram | liter
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  product    PlanProduct @relation(fields: [productId], references: [id])
  ingredient Ingredient  @relation(fields: [ingredientId], references: [id])

  @@unique([productId, ingredientId])
  @@index([productId])
  @@index([ingredientId])
}

enum FinanceCategory {
  BAHAN
  PAYROLL
  BUILDING
  OPERASIONAL
  TRANSPORT
  PERLENGKAPAN
  MARKETING
}

model FinanceWeek {
  id        Int             @id @default(autoincrement())
  name      String
  month     Int
  year      Int
  startDate DateTime
  endDate   DateTime
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  periods   FinancePeriod[]
}

model FinancePeriod {
  id        Int                  @id @default(autoincrement())
  name      String
  month     Int
  year      Int
  startDate DateTime
  endDate   DateTime
  weekId    Int?
  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt
  plans     FinancePlanEntry[]
  actuals   FinanceActualEntry[]
  debts     FinanceDebtPayment[]

  week FinanceWeek? @relation(fields: [weekId], references: [id], onDelete: SetNull)

  @@index([weekId])
}

model FinancePlanEntry {
  id        Int             @id @default(autoincrement())
  periodId  Int
  category  FinanceCategory
  amount    Int
  data      Json?
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  period FinancePeriod @relation(fields: [periodId], references: [id], onDelete: Cascade)

  @@index([periodId, category])
}

model FinanceActualEntry {
  id        Int             @id @default(autoincrement())
  periodId  Int
  category  FinanceCategory
  amount    Int
  data      Json?
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  period FinancePeriod @relation(fields: [periodId], references: [id], onDelete: Cascade)

  @@index([periodId, category])
}

// Record of debt repayments (terms) for each finance period/week
model FinanceDebtPayment {
  id        Int      @id @default(autoincrement())
  periodId  Int
  term      Int // 1-based term number per period
  amount    Int // Rupiah
  note      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  period FinancePeriod @relation(fields: [periodId], references: [id], onDelete: Cascade)

  @@index([periodId])
}

// Monthly user bonus entries (accumulate and paid later)
model UserBonus {
  id        Int      @id @default(autoincrement())
  userId    Int
  year      Int
  month     Int // 1..12
  amount    Int
  note      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, year, month])
}

model PayrollSnapshot {
  id          Int      @id @default(autoincrement())
  userId      Int
  year        Int
  month       Int // 1..12
  baseSalary  Int      @default(0)
  hourlyRate  Int      @default(0)
  penaltyRate Int      @default(0)
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, year, month])
  @@index([year, month])
}
